-- ì¼ì¼ê³µë°© (Daily Workshop) ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
-- Supabase PostgreSQLì—ì„œ ì‹¤í–‰

-- 1. ìœ ì € í…Œì´ë¸” (ìµëª… ë¡œê·¸ì¸ ì§€ì›)
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    gold INTEGER DEFAULT 0
);

-- 2. ì›ì†Œ(ë‹¨ì–´) í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS elements (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    emoji VARCHAR(10),
    is_base_element BOOLEAN DEFAULT FALSE,
    depth INTEGER DEFAULT 1, -- ë‚œì´ë„ ë ˆë²¨ (ê¸°ë³¸ ì›ì†Œ=1, ì¡°í•©í• ìˆ˜ë¡ ì¦ê°€)
    discovered_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. ì¡°í•© ë ˆì‹œí”¼ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS recipes (
    input_a BIGINT REFERENCES elements(id),
    input_b BIGINT REFERENCES elements(id),
    result BIGINT REFERENCES elements(id),
    PRIMARY KEY (input_a, input_b)
);

-- 4. ì¼ì¼ ì±Œë¦°ì§€ í…Œì´ë¸” (ë§¤ì¼ ëª©í‘œ ë‹¨ì–´)
CREATE TABLE IF NOT EXISTS daily_challenges (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    date DATE NOT NULL UNIQUE,
    target_element_id BIGINT REFERENCES elements(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. ì¼ì¼ ì§„í–‰ ìƒí™© í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS daily_progress (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    challenge_id BIGINT REFERENCES daily_challenges(id),
    date DATE DEFAULT CURRENT_DATE,
    found_elements BIGINT[],
    move_count INTEGER DEFAULT 0,
    start_time TIMESTAMPTZ DEFAULT NOW(),
    is_completed BOOLEAN DEFAULT FALSE,
    completed_at TIMESTAMPTZ,
    UNIQUE(user_id, date)
);

-- 6. ê¸°ë³¸ 4ì›ì†Œ ì‚½ì… (depth=1)
INSERT INTO elements (name, emoji, is_base_element, depth) VALUES
    ('ë¬¼', 'ğŸ’§', TRUE, 1),
    ('ë¶ˆ', 'ğŸ”¥', TRUE, 1),
    ('í™', 'ğŸŒ', TRUE, 1),
    ('ê³µê¸°', 'ğŸ’¨', TRUE, 1)
ON CONFLICT (name) DO NOTHING;

-- 7. ì¸ë±ìŠ¤ ìƒì„± (ì„±ëŠ¥ ìµœì í™”)
CREATE INDEX IF NOT EXISTS idx_elements_name ON elements(name);
CREATE INDEX IF NOT EXISTS idx_elements_depth ON elements(depth);
CREATE INDEX IF NOT EXISTS idx_recipes_result ON recipes(result);
CREATE INDEX IF NOT EXISTS idx_daily_challenges_date ON daily_challenges(date);
CREATE INDEX IF NOT EXISTS idx_daily_progress_user_date ON daily_progress(user_id, date);
